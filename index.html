<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スタンプラリー</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
        /* スタイルは省略 */
    </style>
</head>
<body>
    <h1>スタンプラリー</h1>
    <p>🏷️ <span id="stampCount">0</span> 個</p>
    <p>交換済み商品券: <span id="exchangedVouchers">0</span> 枚</p>
    <p>2 → 1 交換</p>
    <p>3 → 2 交換</p>

    <button id="scanQrButton">📷 QRコードをスキャン</button>

    <p id="qrCodeData">QRコードの読み取り結果がここに表示されます。</p>

    <script>
        window.onload = function() {
            const LIFF_ID = " 2008067578-By4EN4dJ ";
            const GAS_WEB_APP_URL = " https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec ";

            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                console.log("LIFF initialization successful.");
                const scanButton = document.getElementById('scanQrButton');
                if (scanButton) {
                    scanButton.addEventListener('click', handleScan);
                } else {
                    console.warn("Scan QR button not found. Please ensure your HTML has an element with id='scanQrButton'.");
                }
                updateUserInfo();
            })
            .catch((err) => {
                console.error('LIFF initialization failed:', err);
                window.alert('LIFFアプリの初期化に失敗しました。LINE Developersコンソールの設定を確認してください。エラーコード: ' + (err.code || '不明') + ', メッセージ: ' + (err.message || '不明'));
            });

            async function handleScan() {
                try {
                    console.log("Attempting to scan QR code...");
                    const result = await liff.scanCodeV2();
                    const scannedValue = result.value;

                    const qrCodeDataElement = document.getElementById('qrCodeData');
                    if (qrCodeDataElement) {
                        qrCodeDataElement.textContent = `読み取ったQRコード: ${scannedValue}`;
                    }

                    if (scannedValue) {
                        console.log(`QRコードを読み取りました: ${scannedValue}`);
                        window.alert(`QRコードを読み取りました: ${scannedValue}\nスタンプ獲得処理を開始します...`);

                        // 読み取り後、自動的にスタンプ獲得処理に接続
                        await sendStampToGAS(scannedValue);
                    } else {
                        window.alert('QRコードが読み取れませんでした。もう一度お試しください。');
                    }
                } catch (err) {
                    console.error('QR code scan failed:', err);
                    let errorMessage = 'QRコードのスキャン中にエラーが発生しました。';
                    if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) {
                        errorMessage += 'LIFFアプリの設定（Scan QR ON、画面サイズFull）やLINEアプリのバージョンを確認してください。';
                    } else if (err.message) {
                        errorMessage += `メッセージ: ${err.message}`;
                    }
                    window.alert(errorMessage);
                }
            }

            async function sendStampToGAS(qrCodeValue) {
                // 関数の中身は変更なし
                try {
                    const userId = liff.getContext()?.userId || null;
                    let userProfile = null;
                    // ... (sendStampToGAS関数の残りのコード)
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        // ...
                        body: JSON.stringify({
                            action: 'addStamp',
                            qrCode: qrCodeValue,
                            userId: userId,
                            userProfile: userProfile
                        })
                    });
                    const gasResult = await response.json();
                    if (gasResult.success) {
                        window.alert('スタンプ獲得成功！');
                        updateUserInfo(); // UIを更新
                    } else {
                        window.alert(`スタンプ獲得失敗: ${gasResult.message || '不明なエラー'}`);
                    }
                } catch (err) {
                    console.error('スタンプ獲得リクエストに失敗しました:', err);
                    window.alert('スタンプ獲得処理中にエラーが発生しました。メッセージ: ' + err.message);
                }
            }

            async function updateUserInfo() {
                // 関数の中身は変更なし
            }
        };
    </script>
</body>
</html>
