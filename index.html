<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ */
    </style>
</head>
<body>
    <h1>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
    <p>ğŸ·ï¸ <span id="stampCount">0</span> å€‹</p>
    <p>äº¤æ›æ¸ˆã¿å•†å“åˆ¸: <span id="exchangedVouchers">0</span> æš</p>
    <p>2 â†’ 1 äº¤æ›</p>
    <p>3 â†’ 2 äº¤æ›</p>

    <button id="scanQrButton">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

    <p id="qrCodeData">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

    <script>
        window.onload = function() {
            const LIFF_ID = " 2008067578-By4EN4dJ ";
            const GAS_WEB_APP_URL = " https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec ";

            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                console.log("LIFF initialization successful.");
                const scanButton = document.getElementById('scanQrButton');
                if (scanButton) {
                    scanButton.addEventListener('click', handleScan);
                } else {
                    console.warn("Scan QR button not found. Please ensure your HTML has an element with id='scanQrButton'.");
                }
                updateUserInfo();
            })
            .catch((err) => {
                console.error('LIFF initialization failed:', err);
                window.alert('LIFFã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + (err.code || 'ä¸æ˜') + ', ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + (err.message || 'ä¸æ˜'));
            });

            async function handleScan() {
                try {
                    console.log("Attempting to scan QR code...");
                    const result = await liff.scanCodeV2();
                    const scannedValue = result.value;

                    const qrCodeDataElement = document.getElementById('qrCodeData');
                    if (qrCodeDataElement) {
                        qrCodeDataElement.textContent = `èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰: ${scannedValue}`;
                    }

                    if (scannedValue) {
                        console.log(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}`);
                        window.alert(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}\nã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...`);

                        // èª­ã¿å–ã‚Šå¾Œã€è‡ªå‹•çš„ã«ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã«æ¥ç¶š
                        await sendStampToGAS(scannedValue);
                    } else {
                        window.alert('QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                } catch (err) {
                    console.error('QR code scan failed:', err);
                    let errorMessage = 'QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) {
                        errorMessage += 'LIFFã‚¢ãƒ—ãƒªã®è¨­å®šï¼ˆScan QR ONã€ç”»é¢ã‚µã‚¤ã‚ºFullï¼‰ã‚„LINEã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (err.message) {
                        errorMessage += `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}`;
                    }
                    window.alert(errorMessage);
                }
            }

            async function sendStampToGAS(qrCodeValue) {
                // é–¢æ•°ã®ä¸­èº«ã¯å¤‰æ›´ãªã—
                try {
                    const userId = liff.getContext()?.userId || null;
                    let userProfile = null;
                    // ... (sendStampToGASé–¢æ•°ã®æ®‹ã‚Šã®ã‚³ãƒ¼ãƒ‰)
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        // ...
                        body: JSON.stringify({
                            action: 'addStamp',
                            qrCode: qrCodeValue,
                            userId: userId,
                            userProfile: userProfile
                        })
                    });
                    const gasResult = await response.json();
                    if (gasResult.success) {
                        window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æˆåŠŸï¼');
                        updateUserInfo(); // UIã‚’æ›´æ–°
                    } else {
                        window.alert(`ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å¤±æ•—: ${gasResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                    }
                } catch (err) {
                    console.error('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + err.message);
                }
            }

            async function updateUserInfo() {
                // é–¢æ•°ã®ä¸­èº«ã¯å¤‰æ›´ãªã—
            }
        };
    </script>
</body>
</html>
