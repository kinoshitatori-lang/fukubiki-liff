<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    <!-- LIFF SDKã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ã“ã‚Œã¯ <head> ã‚¿ã‚°å†…ã€ã¾ãŸã¯ </body> é–‰ã˜ã‚¿ã‚°ã®ç›´å‰ã«é…ç½®ã—ã¾ã™ã€‚ -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- é–‹ç™ºä¸­ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã¨ã—ã¦ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã† [1] -->
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¾‹ (å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ãƒ»å¤‰æ›´ã—ã¦ãã ã•ã„) */
     body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'Yu Gothic Medium', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ Medium', YuGothic, 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“', 'Meiryo UI', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS PGothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4a5568;
            margin: 0;
            font-size: 24px;
        }
        .user-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        .stamp-count {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }
        .qr-input {
            margin-bottom: 25px;
        }
        .qr-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .qr-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .exchange-section {
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f56565;
        }
        .exchange-buttons {
            display: flex;
            gap: 10px;
        }
        .exchange-btn {
            flex: 1;
            padding: 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .exchange-btn:hover:not(:disabled) {
            background: #e53e3e;
        }
        .exchange-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .stamps-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .stamp-item {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stamp-item:last-child {
            border-bottom: none;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .message.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
    </style>
</head>
<body>
    <h1>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
    <p>ğŸ·ï¸ <span id="stampCount">0</span> å€‹</p>
    <p>äº¤æ›æ¸ˆã¿å•†å“åˆ¸: <span id="exchangedVouchers">0</span> æš</p>
    <p>2 â†’ 1 äº¤æ›</p>
    <p>3 â†’ 2 äº¤æ›</p>

    <!-- QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã€‚ã“ã®ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¾ã™ã€‚ -->
    <button id="scanQrButton">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <!-- èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ -->
    <p id="qrCodeData">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

    <!-- ã€ŒğŸ·ï¸ ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ã€ãƒœã‚¿ãƒ³ã¯ã€QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå¾Œã«è‡ªå‹•ã§GASã«é€£æºã™ã‚‹ãŸã‚ã€
         ç›´æ¥çš„ãªã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æ©Ÿèƒ½ã¯JavaScriptã«çµ±åˆã•ã‚Œã¾ã™ã€‚
         ã“ã®ãƒœã‚¿ãƒ³ã¯ã€ã‚‚ã—æ‰‹å‹•ã§ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãŸã„å ´åˆã‚„ã€
         åˆ¥ã®ç›®çš„ã§åˆ©ç”¨ã™ã‚‹å ´åˆã«ã®ã¿æ®‹ã—ã¦ãã ã•ã„ã€‚button id="manualStampButton">ğŸ·ï¸ ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—</button
    -->
 

    <!-- ä»¥ä¸‹ã®JavaScriptã‚’<script>ã‚¿ã‚°ã§ç›´æ¥è¨˜è¿°ã™ã‚‹ã‹ã€åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: `main.js`ï¼‰ã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚ -->
    <script>
       window.onload = function() {
    // âš ï¸ ã“ã“ã«ã‚ãªãŸã®LIFF IDã‚’è¨­å®šã—ã¦ãã ã•ã„ (LIFF Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—) [4]
    const LIFF_ID = " 2008067578-By4EN4dJ ";
    // âš ï¸ ã“ã“ã«ã‚ãªãŸã®GAS Webã‚¢ãƒ—ãƒªã®å…¬é–‹URLã‚’è¨­å®šã—ã¦ãã ã•ã„
    const GAS_WEB_APP_URL = " https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec ";

    // LIFFã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™ [5]
    liff.init({
        liffId: LIFF_ID // [6]
    })
    .then(() => {
        console.log("LIFF initialization successful.");
        // LIFFã®åˆæœŸåŒ–ãŒæˆåŠŸã—ãŸã‚‰ã€QRã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
        const scanButton = document.getElementById('scanQrButton');
        if (scanButton) {
            scanButton.addEventListener('click', handleScan);
        } else {
            console.warn("Scan QR button not found. Please ensure your HTML has an element with id='scanQrButton'.");
        }
        // åˆæœŸåŒ–æˆåŠŸæ™‚ã«ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’GASã‹ã‚‰å–å¾—ã—ã¦UIã‚’æ›´æ–° [7]
        updateUserInfo();
    })
    .catch((err) => {
        // LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° [8, 9]
        console.error('LIFF initialization failed:', err);
        window.alert('LIFFã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + (err.code || 'ä¸æ˜') + ', ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + (err.message || 'ä¸æ˜'));
    });

    /**
     * QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
     */
    async function handleScan() {
        try {
            console.log("Attempting to scan QR code...");
            // liff.scanCodeV2() ã‚’å‘¼ã³å‡ºã—ã¦QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ [10]
            const result = await liff.scanCodeV2();
            const scannedValue = result.value; // èª­ã¿å–ã£ãŸæ–‡å­—åˆ—ãŒ 'value' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å«ã¾ã‚Œã¾ã™ [11]

            const qrCodeDataElement = document.getElementById('qrCodeData');
            if (qrCodeDataElement) {
                qrCodeDataElement.textContent = `èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰: ${scannedValue}`; // UIã«è¡¨ç¤º
            }

            if (scannedValue) {
                console.log(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}`);
                window.alert(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}\nã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...`);

                // èª­ã¿å–ã‚Šå¾Œã€è‡ªå‹•çš„ã«ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã«æ¥ç¶š
                await sendStampToGAS(scannedValue);

            } else {
                window.alert('QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }

        } catch (err) {
            console.error('QR code scan failed:', err); // [11]
            let errorMessage = 'QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŸºã«ã€ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º [8]
            if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) { // [4]
                errorMessage += 'LIFFã‚¢ãƒ—ãƒªã®è¨­å®šï¼ˆScan QR ONã€ç”»é¢ã‚µã‚¤ã‚ºFullï¼‰ã‚„LINEã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'; // [10, 12-14]
            } else if (err.message) {
                errorMessage += `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}`;
            }
            window.alert(errorMessage);
        }
    }

    /**
     * GASã«ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
     * @param {string} qrCodeValue - èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰ã®å€¤
     */
    async function sendStampToGAS(qrCodeValue) {
        try {
            const userId = liff.getContext()?.userId || null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾— [15]
            let userProfile = null;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLIFFã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠã‚Šã€ã‹ã¤'profile'ã‚¹ã‚³ãƒ¼ãƒ—ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚Œã°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾— [2, 16, 17]
            if (liff.isLoggedIn() && liff.getContext()?.scope?.includes('profile')) {
                userProfile = await liff.getProfile(); // [2]
                console.log("User profile obtained:", userProfile.displayName);
            } else {
                console.warn("User is not logged in or 'profile' scope is not granted. Cannot get full user profile.");
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå–å¾—ã§ããªã„å ´åˆã®ä»£æ›¿å‡¦ç† (GASã®addStampãŒuserProfileã‚’æœŸå¾…ã™ã‚‹ãŸã‚)
                userProfile = { displayName: `ãƒ¦ãƒ¼ã‚¶ãƒ¼_${userId ? userId.substring(0, 8) : 'Unknown'}` };
            }

            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'addStamp', // æ—¢å­˜ã‚³ãƒ¼ãƒ‰2ã®doPosté–¢æ•°ã«åˆã‚ã›ã‚‹ [7]
                    qrCode: qrCodeValue,
                    userId: userId,
                    userProfile: userProfile // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’GASã«é€ä¿¡ [7, 18]
                })
            });

            const gasResult = await response.json();
            console.log('GASã‹ã‚‰ã®å¿œç­” (addStamp):', gasResult);

            if (gasResult.success) { // æ—¢å­˜ã‚³ãƒ¼ãƒ‰2ã®å¿œç­”å½¢å¼ã«åˆã‚ã›ã‚‹ [19]
                window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æˆåŠŸï¼');
                // GASã‹ã‚‰ã®å¿œç­”ã§UIã‚’æ›´æ–°
                const stampCountElement = document.getElementById('stampCount');
                if (stampCountElement && gasResult.stampCount !== undefined) {
                    stampCountElement.textContent = gasResult.stampCount;
                }
                // æœ€æ–°ã®ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€UIã‚’å†æ›´æ–°
                updateUserInfo();
            } else {
                window.alert(`ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å¤±æ•—: ${gasResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
            }

        } catch (err) {
            console.error('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
            window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + err.message);
        }
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’GASã‹ã‚‰å–å¾—ã—ã¦UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
     */
    async function updateUserInfo() {
        try {
            if (!liff.isLoggedIn()) { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª [16]
                console.log("Not logged in. Cannot fetch user info for UI update.");
                return;
            }

            const userId = liff.getContext()?.userId || null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾— [15]
            if (!userId) {
                console.warn("User ID not available for UI update.");
                return;
            }

            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getUserInfo', // æ—¢å­˜ã‚³ãƒ¼ãƒ‰2ã®doPosté–¢æ•°ã«åˆã‚ã›ã‚‹ [7]
                    userId: userId
                })
            });

            const gasResult = await response.json();
            console.log('GASã‹ã‚‰ã®å¿œç­” (getUserInfo):', gasResult);

            if (gasResult.success && gasResult.user) { // æ—¢å­˜ã‚³ãƒ¼ãƒ‰2ã®å¿œç­”å½¢å¼ã«åˆã‚ã›ã‚‹ [20]
                document.getElementById('stampCount').textContent = gasResult.user.totalStamps;
                document.getElementById('exchangedVouchers').textContent = gasResult.user.exchangedVouchers;
            } else {
                console.warn("Failed to fetch user info from GAS:", gasResult.message);
            }
        } catch (error) {
            console.error("Error updating user info:", error);
            window.alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + error.message);
        }
    }
};

    </script>
</body>
</html>
