<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スタンプラリー</title>
    <!-- LIFF SDKを読み込みます。これは <head> タグ内、または </body> 閉じタグの直前に配置します。 -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 開発中のキャッシュ対策として以下を追加すると良いでしょう [1] -->
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
        /* スタイルの例 (必要に応じて追加・変更してください) */
     body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ヒラギノ角ゴ Pro', 'Yu Gothic Medium', '游ゴシック Medium', YuGothic, '游ゴシック体', 'Meiryo UI', 'メイリオ', Meiryo, 'MS PGothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4a5568;
            margin: 0;
            font-size: 24px;
        }
        .user-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        .stamp-count {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }
        .qr-input {
            margin-bottom: 25px;
        }
        .qr-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .qr-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .exchange-section {
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f56565;
        }
        .exchange-buttons {
            display: flex;
            gap: 10px;
        }
        .exchange-btn {
            flex: 1;
            padding: 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .exchange-btn:hover:not(:disabled) {
            background: #e53e3e;
        }
        .exchange-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .stamps-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .stamp-item {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stamp-item:last-child {
            border-bottom: none;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .message.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
    </style>
</head>
<body>
    <h1>スタンプラリー</h1>
    <p>🏷️ <span id="stampCount">0</span> 個</p>
    <p>交換済み商品券: <span id="exchangedVouchers">0</span> 枚</p>
    <p>2 → 1 交換</p>
    <p>3 → 2 交換</p>

    <!-- QRコードスキャンボタン。このボタンがクリックされたときにカメラを起動します。 -->
    <button id="scanQrButton">📷 QRコードをスキャン</button>
    <!-- 読み取ったQRコードのデータを表示する場所 -->
    <p id="qrCodeData">QRコードの読み取り結果がここに表示されます。</p>

    <!-- 「🏷️ スタンプ獲得」ボタンは、QRコード読み取り後に自動でGASに連携するため、
         直接的なスタンプ獲得機能はJavaScriptに統合されます。
         このボタンは、もし手動でスタンプ獲得処理をトリガーしたい場合や、
         別の目的で利用する場合にのみ残してください。button id="manualStampButton">🏷️ スタンプ獲得</button
    -->
 

    <!-- 以下のJavaScriptを<script>タグで直接記述するか、別のファイル（例: `main.js`）として読み込みます。 -->
    <script>
       window.onload = function() {
    // ⚠️ ここにあなたのLIFF IDを設定してください (LIFF Developersコンソールで取得) [4]
    const LIFF_ID = " 2008067578-By4EN4dJ ";
    // ⚠️ ここにあなたのGAS Webアプリの公開URLを設定してください
    const GAS_WEB_APP_URL = " https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec ";

    // LIFFアプリを初期化します [5]
    liff.init({
        liffId: LIFF_ID // [6]
    })
    .then(() => {
        console.log("LIFF initialization successful.");
        // LIFFの初期化が成功したら、QRスキャンボタンにイベントリスナーを設定します。
        const scanButton = document.getElementById('scanQrButton');
        if (scanButton) {
            scanButton.addEventListener('click', handleScan);
        } else {
            console.warn("Scan QR button not found. Please ensure your HTML has an element with id='scanQrButton'.");
        }
        // 初期化成功時に、現在のユーザー情報をGASから取得してUIを更新 [7]
        updateUserInfo();
    })
    .catch((err) => {
        // LIFFの初期化に失敗した場合のエラーハンドリング [8, 9]
        console.error('LIFF initialization failed:', err);
        window.alert('LIFFアプリの初期化に失敗しました。LINE Developersコンソールの設定を確認してください。エラーコード: ' + (err.code || '不明') + ', メッセージ: ' + (err.message || '不明'));
    });

    /**
     * QRコードスキャンボタンがクリックされたときの処理
     */
    async function handleScan() {
        try {
            console.log("Attempting to scan QR code...");
            // liff.scanCodeV2() を呼び出してQRコードリーダーを起動します [10]
            const result = await liff.scanCodeV2();
            const scannedValue = result.value; // 読み取った文字列が 'value' プロパティに含まれます [11]

            const qrCodeDataElement = document.getElementById('qrCodeData');
            if (qrCodeDataElement) {
                qrCodeDataElement.textContent = `読み取ったQRコード: ${scannedValue}`; // UIに表示
            }

            if (scannedValue) {
                console.log(`QRコードを読み取りました: ${scannedValue}`);
                window.alert(`QRコードを読み取りました: ${scannedValue}\nスタンプ獲得処理を開始します...`);

                // 読み取り後、自動的にスタンプ獲得処理に接続
                await sendStampToGAS(scannedValue);

            } else {
                window.alert('QRコードが読み取れませんでした。もう一度お試しください。');
            }

        } catch (err) {
            console.error('QR code scan failed:', err); // [11]
            let errorMessage = 'QRコードのスキャン中にエラーが発生しました。';
            // エラーコードやメッセージを基に、より詳細なエラー情報を表示 [8]
            if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) { // [4]
                errorMessage += 'LIFFアプリの設定（Scan QR ON、画面サイズFull）やLINEアプリのバージョンを確認してください。'; // [10, 12-14]
            } else if (err.message) {
                errorMessage += `メッセージ: ${err.message}`;
            }
            window.alert(errorMessage);
        }
    }

    /**
     * GASにスタンプ獲得リクエストを送信する関数
     * @param {string} qrCodeValue - 読み取ったQRコードの値
     */
    async function sendStampToGAS(qrCodeValue) {
        try {
            const userId = liff.getContext()?.userId || null; // ユーザーIDを取得 [15]
            let userProfile = null;

            // ユーザーがLIFFにログインしており、かつ'profile'スコープが許可されていればプロフィールを取得 [2, 16, 17]
            if (liff.isLoggedIn() && liff.getContext()?.scope?.includes('profile')) {
                userProfile = await liff.getProfile(); // [2]
                console.log("User profile obtained:", userProfile.displayName);
            } else {
                console.warn("User is not logged in or 'profile' scope is not granted. Cannot get full user profile.");
                // プロフィールが取得できない場合の代替処理 (GASのaddStampがuserProfileを期待するため)
                userProfile = { displayName: `ユーザー_${userId ? userId.substring(0, 8) : 'Unknown'}` };
            }

            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'addStamp', // 既存コード2のdoPost関数に合わせる [7]
                    qrCode: qrCodeValue,
                    userId: userId,
                    userProfile: userProfile // ユーザープロフィールをGASに送信 [7, 18]
                })
            });

            const gasResult = await response.json();
            console.log('GASからの応答 (addStamp):', gasResult);

            if (gasResult.success) { // 既存コード2の応答形式に合わせる [19]
                window.alert('スタンプ獲得成功！');
                // GASからの応答でUIを更新
                const stampCountElement = document.getElementById('stampCount');
                if (stampCountElement && gasResult.stampCount !== undefined) {
                    stampCountElement.textContent = gasResult.stampCount;
                }
                // 最新のスタンプ数を表示するために、UIを再更新
                updateUserInfo();
            } else {
                window.alert(`スタンプ獲得失敗: ${gasResult.message || '不明なエラー'}`);
            }

        } catch (err) {
            console.error('スタンプ獲得リクエストに失敗しました:', err);
            window.alert('スタンプ獲得処理中にエラーが発生しました。メッセージ: ' + err.message);
        }
    }

    /**
     * ユーザー情報とスタンプ数をGASから取得してUIを更新する関数
     */
    async function updateUserInfo() {
        try {
            if (!liff.isLoggedIn()) { // ユーザーがログインしているか確認 [16]
                console.log("Not logged in. Cannot fetch user info for UI update.");
                return;
            }

            const userId = liff.getContext()?.userId || null; // ユーザーIDを取得 [15]
            if (!userId) {
                console.warn("User ID not available for UI update.");
                return;
            }

            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getUserInfo', // 既存コード2のdoPost関数に合わせる [7]
                    userId: userId
                })
            });

            const gasResult = await response.json();
            console.log('GASからの応答 (getUserInfo):', gasResult);

            if (gasResult.success && gasResult.user) { // 既存コード2の応答形式に合わせる [20]
                document.getElementById('stampCount').textContent = gasResult.user.totalStamps;
                document.getElementById('exchangedVouchers').textContent = gasResult.user.exchangedVouchers;
            } else {
                console.warn("Failed to fetch user info from GAS:", gasResult.message);
            }
        } catch (error) {
            console.error("Error updating user info:", error);
            window.alert('ユーザー情報の取得中にエラーが発生しました。メッセージ: ' + error.message);
        }
    }
};

    </script>
</body>
</html>
