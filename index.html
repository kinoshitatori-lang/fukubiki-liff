<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
       Â body {

Â  Â  Â  Â  Â  Â  font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'Yu Gothic Medium', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ Medium', YuGothic, 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“', 'Meiryo UI', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS PGothic', sans-serif;

Â  Â  Â  Â  Â  Â  margin: 0;

Â  Â  Â  Â  Â  Â  padding: 20px;

Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

Â  Â  Â  Â  Â  Â  min-height: 100vh;

Â  Â  Â  Â  Â  Â  color: #333;

Â  Â  Â  Â  }

Â  Â  Â  Â  .container {

Â  Â  Â  Â  Â  Â  max-width: 400px;

Â  Â  Â  Â  Â  Â  margin: 0 auto;

Â  Â  Â  Â  Â  Â  background: white;

Â  Â  Â  Â  Â  Â  border-radius: 15px;

Â  Â  Â  Â  Â  Â  padding: 25px;

Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.2);

Â  Â  Â  Â  }

Â  Â  Â  Â  .header {

Â  Â  Â  Â  Â  Â  text-align: center;

Â  Â  Â  Â  Â  Â  margin-bottom: 30px;

Â  Â  Â  Â  }

Â  Â  Â  Â  .header h1 {

Â  Â  Â  Â  Â  Â  color: #4a5568;

Â  Â  Â  Â  Â  Â  margin: 0;

Â  Â  Â  Â  Â  Â  font-size: 24px;

Â  Â  Â  Â  }

Â  Â  Â  Â  .user-info {

Â  Â  Â  Â  Â  Â  background: #f7fafc;

Â  Â  Â  Â  Â  Â  padding: 20px;

Â  Â  Â  Â  Â  Â  border-radius: 10px;

Â  Â  Â  Â  Â  Â  margin-bottom: 25px;

Â  Â  Â  Â  Â  Â  border-left: 4px solid #667eea;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stamp-count {

Â  Â  Â  Â  Â  Â  font-size: 28px;

Â  Â  Â  Â  Â  Â  font-weight: bold;

Â  Â  Â  Â  Â  Â  color: #667eea;

Â  Â  Â  Â  Â  Â  text-align: center;

Â  Â  Â  Â  Â  Â  margin: 15px 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  .qr-input {

Â  Â  Â  Â  Â  Â  margin-bottom: 25px;

Â  Â  Â  Â  }

Â  Â  Â  Â  .qr-input input {

Â  Â  Â  Â  Â  Â  width: 100%;

Â  Â  Â  Â  Â  Â  padding: 15px;

Â  Â  Â  Â  Â  Â  border: 2px solid #e2e8f0;

Â  Â  Â  Â  Â  Â  border-radius: 8px;

Â  Â  Â  Â  Â  Â  font-size: 16px;

Â  Â  Â  Â  Â  Â  box-sizing: border-box;

Â  Â  Â  Â  }

Â  Â  Â  Â  .qr-input input:focus {

Â  Â  Â  Â  Â  Â  outline: none;

Â  Â  Â  Â  Â  Â  border-color: #667eea;

Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);

Â  Â  Â  Â  }

Â  Â  Â  Â  .button {

Â  Â  Â  Â  Â  Â  width: 100%;

Â  Â  Â  Â  Â  Â  padding: 15px;

Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

Â  Â  Â  Â  Â  Â  color: white;

Â  Â  Â  Â  Â  Â  border: none;

Â  Â  Â  Â  Â  Â  border-radius: 8px;

Â  Â  Â  Â  Â  Â  font-size: 16px;

Â  Â  Â  Â  Â  Â  font-weight: bold;

Â  Â  Â  Â  Â  Â  cursor: pointer;

Â  Â  Â  Â  Â  Â  margin-bottom: 15px;

Â  Â  Â  Â  Â  Â  transition: transform 0.2s;

Â  Â  Â  Â  }

Â  Â  Â  Â  .button:hover {

Â  Â  Â  Â  Â  Â  transform: translateY(-2px);

Â  Â  Â  Â  }

Â  Â  Â  Â  .button:disabled {

Â  Â  Â  Â  Â  Â  background: #cbd5e0;

Â  Â  Â  Â  Â  Â  cursor: not-allowed;

Â  Â  Â  Â  Â  Â  transform: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .exchange-section {

Â  Â  Â  Â  Â  Â  background: #fff5f5;

Â  Â  Â  Â  Â  Â  padding: 20px;

Â  Â  Â  Â  Â  Â  border-radius: 10px;

Â  Â  Â  Â  Â  Â  margin-bottom: 20px;

Â  Â  Â  Â  Â  Â  border-left: 4px solid #f56565;

Â  Â  Â  Â  }

Â  Â  Â  Â  .exchange-buttons {

Â  Â  Â  Â  Â  Â  display: flex;

Â  Â  Â  Â  Â  Â  gap: 10px;

Â  Â  Â  Â  }

Â  Â  Â  Â  .exchange-btn {

Â  Â  Â  Â  Â  Â  flex: 1;

Â  Â  Â  Â  Â  Â  padding: 12px;

Â  Â  Â  Â  Â  Â  background: #f56565;

Â  Â  Â  Â  Â  Â  color: white;

Â  Â  Â  Â  Â  Â  border: none;

Â  Â  Â  Â  Â  Â  border-radius: 6px;

Â  Â  Â  Â  Â  Â  font-size: 14px;

Â  Â  Â  Â  Â  Â  cursor: pointer;

Â  Â  Â  Â  Â  Â  transition: background 0.2s;

Â  Â  Â  Â  }

Â  Â  Â  Â  .exchange-btn:hover:not(:disabled) {

Â  Â  Â  Â  Â  Â  background: #e53e3e;

Â  Â  Â  Â  }

Â  Â  Â  Â  .exchange-btn:disabled {

Â  Â  Â  Â  Â  Â  background: #cbd5e0;

Â  Â  Â  Â  Â  Â  cursor: not-allowed;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stamps-list {

Â  Â  Â  Â  Â  Â  max-height: 200px;

Â  Â  Â  Â  Â  Â  overflow-y: auto;

Â  Â  Â  Â  Â  Â  border: 1px solid #e2e8f0;

Â  Â  Â  Â  Â  Â  border-radius: 8px;

Â  Â  Â  Â  Â  Â  padding: 15px;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stamp-item {

Â  Â  Â  Â  Â  Â  padding: 10px;

Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #e2e8f0;

Â  Â  Â  Â  Â  Â  display: flex;

Â  Â  Â  Â  Â  Â  justify-content: space-between;

Â  Â  Â  Â  Â  Â  align-items: center;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stamp-item:last-child {

Â  Â  Â  Â  Â  Â  border-bottom: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .loading {

Â  Â  Â  Â  Â  Â  text-align: center;

Â  Â  Â  Â  Â  Â  padding: 40px 20px;

Â  Â  Â  Â  Â  Â  color: #666;

Â  Â  Â  Â  }

Â  Â  Â  Â  .message {

Â  Â  Â  Â  Â  Â  padding: 15px;

Â  Â  Â  Â  Â  Â  border-radius: 8px;

Â  Â  Â  Â  Â  Â  margin-bottom: 20px;

Â  Â  Â  Â  Â  Â  text-align: center;

Â  Â  Â  Â  }

Â  Â  Â  Â  .message.success {

Â  Â  Â  Â  Â  Â  background: #f0fff4;

Â  Â  Â  Â  Â  Â  color: #22543d;

Â  Â  Â  Â  Â  Â  border: 1px solid #9ae6b4;

Â  Â  Â  Â  }

Â  Â  Â  Â  .message.error {

Â  Â  Â  Â  Â  Â  background: #fed7d7;

Â  Â  Â  Â  Â  Â  color: #742a2a;

Â  Â  Â  Â  Â  Â  border: 1px solid #feb2b2;

Â  Â  Â  Â  }
    </style>
</head>
<body>
    <h1>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
    <p>ğŸ·ï¸ <span id="stampCount">0</span> å€‹</p>
    <p>äº¤æ›æ¸ˆã¿å•†å“åˆ¸: <span id="exchangedVouchers">0</span> æš</p>
    <p>2 â†’ 1 äº¤æ›</p>
    <p>3 â†’ 2 äº¤æ›</p>

    <button id="scanQrButton">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

    <p id="qrCodeData">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

    <script>
        window.onload = function() {
            const LIFF_ID = " 2008067578-By4EN4dJ ";
            const GAS_WEB_APP_URL = " https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec ";

            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                console.log("LIFF initialization successful.");
                const scanButton = document.getElementById('scanQrButton');
                if (scanButton) {
                    scanButton.addEventListener('click', handleScan);
                } else {
                    console.warn("Scan QR button not found. Please ensure your HTML has an element with id='scanQrButton'.");
                }
                updateUserInfo();
            })
            .catch((err) => {
                console.error('LIFF initialization failed:', err);
                window.alert('LIFFã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + (err.code || 'ä¸æ˜') + ', ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + (err.message || 'ä¸æ˜'));
            });

            async function handleScan() {
                try {
                    console.log("Attempting to scan QR code...");
                    const result = await liff.scanCodeV2();
                    const scannedValue = result.value;

                    const qrCodeDataElement = document.getElementById('qrCodeData');
                    if (qrCodeDataElement) {
                        qrCodeDataElement.textContent = `èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰: ${scannedValue}`;
                    }

                    if (scannedValue) {
                        console.log(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}`);
                        window.alert(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}\nã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...`);

                        // èª­ã¿å–ã‚Šå¾Œã€è‡ªå‹•çš„ã«ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã«æ¥ç¶š
                        await sendStampToGAS(scannedValue);
                    } else {
                        window.alert('QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                } catch (err) {
                    console.error('QR code scan failed:', err);
                    let errorMessage = 'QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) {
                        errorMessage += 'LIFFã‚¢ãƒ—ãƒªã®è¨­å®šï¼ˆScan QR ONã€ç”»é¢ã‚µã‚¤ã‚ºFullï¼‰ã‚„LINEã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (err.message) {
                        errorMessage += `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}`;
                    }
                    window.alert(errorMessage);
                }
            }

            async function sendStampToGAS(qrCodeValue) {
                // é–¢æ•°ã®ä¸­èº«ã¯å¤‰æ›´ãªã—
                try {
                    const userId = liff.getContext()?.userId || null;
                    let userProfile = null;
                    // ... (sendStampToGASé–¢æ•°ã®æ®‹ã‚Šã®ã‚³ãƒ¼ãƒ‰)
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        // ...
                        body: JSON.stringify({
                            action: 'addStamp',
                            qrCode: qrCodeValue,
                            userId: userId,
                            userProfile: userProfile
                        })
                    });
                    const gasResult = await response.json();
                    if (gasResult.success) {
                        window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æˆåŠŸï¼');
                        updateUserInfo(); // UIã‚’æ›´æ–°
                    } else {
                        window.alert(`ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å¤±æ•—: ${gasResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                    }
                } catch (err) {
                    console.error('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + err.message);
                }
            }

            async function updateUserInfo() {
                // é–¢æ•°ã®ä¸­èº«ã¯å¤‰æ›´ãªã—
            }
        };
    </script>
</body>
</html>
