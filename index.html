<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache">
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'Yu Gothic Medium', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ Medium', YuGothic, 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“', 'Meiryo UI', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS PGothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4a5568;
            margin: 0;
            font-size: 24px;
        }
        .user-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        .stamp-count {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }
        .qr-input {
            margin-bottom: 25px;
        }
        .qr-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .qr-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .exchange-section {
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f56565;
        }
        .exchange-buttons {
            display: flex;
            gap: 10px;
        }
        .exchange-btn {
            flex: 1;
            padding: 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .exchange-btn:hover:not(:disabled) {
            background: #e53e3e;
        }
        .exchange-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .stamps-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .stamp-item {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stamp-item:last-child {
            border-bottom: none;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .message.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
        </div>
        <div class="user-info">
            <p>ğŸ·ï¸ ã‚¹ã‚¿ãƒ³ãƒ—æ•°: <span id="stampCount">0</span> å€‹</p>
            <p>ğŸ äº¤æ›æ¸ˆã¿å•†å“åˆ¸: <span id="exchangedVouchers">0</span> æš</p>
        </div>

        <button id="scanQrButton" class="button">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

        <p id="qrCodeData" style="text-align: center; color: #718096; font-size: 14px; margin-top: 20px;"></p>

        <div class="exchange-section">
            <h3>å•†å“åˆ¸ã¨äº¤æ›</h3>
            <p style="font-size: 14px; color: #4a5568;">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è²¯ã‚ã¦å•†å“åˆ¸ã«äº¤æ›ã—ã‚ˆã†ï¼</p>
            <div class="exchange-buttons">
                <button id="exchange2for1" class="exchange-btn" disabled>ã‚¹ã‚¿ãƒ³ãƒ—2å€‹ â†’ å•†å“åˆ¸1æš</button>
                <button id="exchange3for2" class="exchange-btn" disabled>ã‚¹ã‚¿ãƒ³ãƒ—3å€‹ â†’ å•†å“åˆ¸2æš</button>
            </div>
        </div>

        <h3>ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å±¥æ­´</h3>
        <div id="stampsList" class="stamps-list">
            </div>
    </div>

    <script>
        window.onload = function() {
            // â˜…LIFF IDã¨GAS URLã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
            const LIFF_ID = "2008067578-By4EN4dJ";
            const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzd4eInt3_k5F0Ckhosy-fdDM8_WY8l17pHI7PO_ipmEm04lDtJqFc7Egebn7eQTb7Zqg/exec";

            let userId;

            // LIFFã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™
            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                if (liff.isLoggedIn()) {
                    userId = liff.getContext()?.userId;
                    console.log("LIFF initialization successful. User ID:", userId);
                    updateUserInfo();
                } else {
                    liff.login();
                }
            })
            .catch((err) => {
                console.error('LIFF initialization failed:', err);
                window.alert('LIFFã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + (err.code || 'ä¸æ˜') + ', ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + (err.message || 'ä¸æ˜'));
            });

            // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const scanButton = document.getElementById('scanQrButton');
            if (scanButton) {
                scanButton.addEventListener('click', handleScan);
            }

            // äº¤æ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('exchange2for1').addEventListener('click', () => exchangeVoucher(1, 2));
            document.getElementById('exchange3for2').addEventListener('click', () => exchangeVoucher(2, 3));

            async function handleScan() {
                try {
                    const result = await liff.scanCodeV2();
                    const scannedValue = result.value;

                    if (scannedValue) {
                        window.alert(`QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${scannedValue}\nã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...`);
                        document.getElementById('qrCodeData').textContent = `èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰: ${scannedValue}`;
                        await sendStampToGAS(scannedValue);
                    } else {
                        window.alert('QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                } catch (err) {
                    console.error('QR code scan failed:', err);
                    let errorMessage = 'QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (err.code === 'FORBIDDEN' || (err.message && err.message.includes('permission'))) {
                        errorMessage += 'LIFFã‚¢ãƒ—ãƒªã®è¨­å®šï¼ˆScan QR ONã€ç”»é¢ã‚µã‚¤ã‚ºFullï¼‰ã‚„LINEã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (err.message) {
                        errorMessage += `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}`;
                    }
                    window.alert(errorMessage);
                }
            }

            async function sendStampToGAS(qrCodeValue) {
                try {
                    const userProfile = await liff.getProfile().catch(() => ({ displayName: 'Unknown' }));
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'addStamp',
                            qrCode: qrCodeValue,
                            userId: userId,
                            userProfile: userProfile
                        })
                    });

                    const gasResult = await response.json();
                    if (gasResult.success) {
                        window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æˆåŠŸï¼');
                        updateUserInfo();
                    } else {
                        window.alert(`ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å¤±æ•—: ${gasResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                    }
                } catch (err) {
                    console.error('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    window.alert('ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + err.message);
                }
            }

            async function updateUserInfo() {
                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'getUserInfo',
                            userId: userId
                        })
                    });

                    const gasResult = await response.json();
                    if (gasResult.success && gasResult.user) {
                        const stampCount = gasResult.user.totalStamps;
                        document.getElementById('stampCount').textContent = stampCount;
                        document.getElementById('exchangedVouchers').textContent = gasResult.user.exchangedVouchers;
                        updateExchangeButtons(stampCount);
                        displayStampsHistory(gasResult.stamps);
                    } else {
                        console.warn("Failed to fetch user info from GAS:", gasResult.message);
                    }
                } catch (error) {
                    console.error("Error updating user info:", error);
                    window.alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + error.message);
                }
            }
            
            async function exchangeVoucher(vouchersToExchange, requiredStamps) {
                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'exchangeVoucher',
                            userId: userId,
                            vouchersToExchange: vouchersToExchange,
                            requiredStamps: requiredStamps
                        })
                    });
                    const gasResult = await response.json();
                    if (gasResult.success) {
                        window.alert(gasResult.message);
                        updateUserInfo();
                    } else {
                        window.alert(gasResult.message);
                    }
                } catch (err) {
                    console.error('å•†å“åˆ¸äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    window.alert('å•†å“åˆ¸äº¤æ›å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + err.message);
                }
            }

            function updateExchangeButtons(currentStamps) {
                const exchange2for1Btn = document.getElementById('exchange2for1');
                const exchange3for2Btn = document.getElementById('exchange3for2');

                exchange2for1Btn.disabled = currentStamps < 2;
                exchange3for2Btn.disabled = currentStamps < 3;
            }

            function displayStampsHistory(stamps) {
                const list = document.getElementById('stampsList');
                list.innerHTML = ''; // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (stamps.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #718096;">ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    stamps.reverse().forEach(stamp => {
                        const date = new Date(stamp.date).toLocaleString('ja-JP');
                        const item = document.createElement('div');
                        item.className = 'stamp-item';
                        item.innerHTML = `
                            <span>${stamp.companyName}</span>
                            <span>${date}</span>
                        `;
                        list.appendChild(item);
                    });
                }
            }
        };
    </script>
</body>
</html>
